<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Detection and Transcription</title>
</head>
<body>
    <h1>KYC</h1>
    <video id="videoElement" width="640" height="480" autoplay muted></video>
    <button id="startButton">Start Listening</button>
    <button id="stopButton" disabled>Stop Listening</button>

    <br><br>

    <h3>Transcribed Text:</h3>
    <p id="transcription">Waiting for speech...</p>

    <script>
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const videoElement = document.getElementById('videoElement');
        const transcriptionElement = document.getElementById('transcription');

        let speechRecognition;
        let allSpeechWhileRecording = "";
        let consentText = "I GIVE CONSENT TO BE POSP OF LANDMARK";
        let stream; // Store the MediaStream
        let audioStream;

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            speechRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            speechRecognition.continuous = true;
            speechRecognition.interimResults = true;

            speechRecognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                allSpeechWhileRecording += transcript;
                transcriptionElement.textContent = transcript;
            };

            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event);
            };

            speechRecognition.onstart = () => {
                transcriptionElement.textContent = 'Listening...';
            };

            speechRecognition.onend = () => {
                transcriptionElement.textContent = 'Stopped listening...';
            };
        } else {
            alert("Speech recognition is not supported in this browser.");
        }

        startButton.addEventListener('click', async () => {
            try {
                // ***CRITICAL CHANGE: Start speech recognition FIRST***
                speechRecognition.start();  // Start it here

                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });

                videoElement.srcObject = stream;
                videoElement.muted = true;

                const audioTracks = stream.getAudioTracks();
                audioStream = new MediaStream(audioTracks); // Create a new stream with ONLY audio

                // Now that speech recognition is running, we can use the audioStream
                // (No need to explicitly set it anywhere, speechRecognition is already listening)

                startButton.disabled = true;
                stopButton.disabled = false;
            } catch (err) {
                console.error('Error accessing media devices:', err);
                speechRecognition.stop(); // Stop recognition if there's an error
                startButton.disabled = false;
                stopButton.disabled = true;
            }
        });

        stopButton.addEventListener('click', () => {
            speechRecognition.stop();
            startButton.disabled = false;
            stopButton.disabled = true;

            if (allSpeechWhileRecording.toUpperCase().includes(consentText)) {
                alert(consentText);
            } else {
                console.log(allSpeechWhileRecording);
            }

            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                videoElement.srcObject = null;
            }
            if(audioStream) {
                const tracks = audioStream.getTracks();
                tracks.forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
