<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio to Text with MediaRecorder</title>
</head>
<body>
    <h1>Audio to Text with MediaRecorder</h1>

    <!-- Video element to show live feed -->
    <video id="videoElement" width="640" height="480" autoplay></video>

    <br><br>

    <!-- Buttons to control recording -->
    <button id="startButton">Start Recording</button>
    <button id="stopButton" disabled>Stop Recording</button>

    <br><br>

    <!-- Display the video content -->
    <h3>Recorded Video:</h3>
    <video id="recordedVideo" controls width="640" height="480"></video>
    <p id="transcription">Speech Transcription...</p>

    <h3>Video as Base64:</h3>
    <textarea id="base64Output" rows="10" cols="80"></textarea>

    <script>
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const videoElement = document.getElementById('videoElement');
        const recordedVideo = document.getElementById('recordedVideo');
        const base64Output = document.getElementById('base64Output');
        const transcriptionElement = document.getElementById('transcription');

        let mediaRecorder;
        let videoStream;
        let audioStream;
        let recordedChunks = [];

        // Check for SpeechRecognition API
        let speechRecognition;
        let allSpeechWhileRecording = "";

        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window) {
            speechRecognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            speechRecognition.continuous = true;  // Keep recognizing continuously
            speechRecognition.interimResults = true;  // Show partial results

            // Event listener for when speech is recognized
            speechRecognition.onresult = (event) => {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript; // Get the recognized text
                }
                allSpeechWhileRecording += transcript;
                transcriptionElement.textContent = transcript; // Display the transcribed text
            };

            // Handle errors
            speechRecognition.onerror = (event) => {
                console.error('Speech recognition error:', event);
            };
        }

        // Start Video Recording
        startButton.addEventListener('click', async () => {
            try {
                // Start Speech Recognition
                speechRecognition.start();

                // Access the webcam and microphone
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videoElement.srcObject = videoStream;

                // Extract the audio stream (this is for the speech-to-text)
                audioStream = new MediaStream(videoStream.getAudioTracks());

                // Initialize MediaRecorder for recording (video and audio)
                mediaRecorder = new MediaRecorder(videoStream);

                mediaRecorder.ondataavailable = (event) => {
                    recordedChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    // Create a Blob from the recorded chunks and create a URL for the video
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const videoUrl = URL.createObjectURL(blob);

                    // Show the video in the 'recordedVideo' element
                    recordedVideo.src = videoUrl;

                    // Convert video to base64 (you can choose another format if you prefer)
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        base64Output.value = reader.result;  // Display base64 in textarea
                    };
                    reader.readAsDataURL(blob);  // Convert to base64
                };

                // Start recording the video
                mediaRecorder.start();
                startButton.disabled = true;
                stopButton.disabled = false;
                transcriptionElement.textContent = 'Listening...';
            } catch (err) {
                console.error('Error accessing media devices:', err);
            }
        });

        // Stop Video Recording
        stopButton.addEventListener('click', () => {
            speechRecognition.stop();
            mediaRecorder.stop();
            videoStream.getTracks().forEach(track => track.stop());  // Stop the media stream

            startButton.disabled = false;
            stopButton.disabled = true;
            transcriptionElement.textContent = 'Stopped listening...'; // Show stopped message
            console.log("Transcribed text:", allSpeechWhileRecording);
        });
    </script>
</body>
</html>
